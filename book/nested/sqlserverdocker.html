<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>SQL Server Terraform/Docker - Machine Shell Book</title>


        <!-- Custom HTML head -->
        
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="icon" href="../favicon.svg">
        <link rel="shortcut icon" href="../favicon.png">
        <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">
        <link rel="stylesheet" href="../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../highlight.css">
        <link rel="stylesheet" href="../tomorrow-night.css">
        <link rel="stylesheet" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->

    </head>
    <body>
    <div id="body-container">
        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = "../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var html = document.querySelector('html');
            var sidebar = null;
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded affix "><a href="../index.html">Intro</a></li><li class="chapter-item expanded "><a href="../main.html"><strong aria-hidden="true">1.</strong> Main</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../nested/links.html"><strong aria-hidden="true">1.1.</strong> Links</a></li></ol></li><li class="chapter-item expanded "><a href="../containerized.html"><strong aria-hidden="true">2.</strong> Containerized</a></li><li><ol class="section"><li class="chapter-item expanded "><div><strong aria-hidden="true">2.1.</strong> Section1</div></li><li class="chapter-item expanded "><div><strong aria-hidden="true">2.2.</strong> Section2</div></li><li class="chapter-item expanded "><div><strong aria-hidden="true">2.3.</strong> Section3</div></li><li class="chapter-item expanded "><div><strong aria-hidden="true">2.4.</strong> Section4</div></li><li class="chapter-item expanded "><div><strong aria-hidden="true">2.5.</strong> Section5</div></li></ol></li><li class="chapter-item expanded "><a href="../shell.html"><strong aria-hidden="true">3.</strong> Shell Scripting</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../nested/ch1section1.html"><strong aria-hidden="true">3.1.</strong> Function - app_is_installed</a></li><li class="chapter-item expanded "><div><strong aria-hidden="true">3.2.</strong> Draft chapter</div></li><li class="chapter-item expanded "><div><strong aria-hidden="true">3.3.</strong> Section2</div></li><li class="chapter-item expanded "><div><strong aria-hidden="true">3.4.</strong> Section3</div></li><li class="chapter-item expanded "><div><strong aria-hidden="true">3.5.</strong> Section4</div></li><li class="chapter-item expanded "><div><strong aria-hidden="true">3.6.</strong> Section5</div></li></ol></li><li class="chapter-item expanded "><a href="../databases.html"><strong aria-hidden="true">4.</strong> Databases</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../nested/sqlserverdocker.html" class="active"><strong aria-hidden="true">4.1.</strong> SQL Server Terraform/Docker</a></li><li class="chapter-item expanded "><div><strong aria-hidden="true">4.2.</strong> Section2</div></li><li class="chapter-item expanded "><div><strong aria-hidden="true">4.3.</strong> Section3</div></li><li class="chapter-item expanded "><div><strong aria-hidden="true">4.4.</strong> Section4</div></li><li class="chapter-item expanded "><div><strong aria-hidden="true">4.5.</strong> Section5</div></li></ol></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <!-- Track and set sidebar scroll position -->
        <script>
            var sidebarScrollbox = document.querySelector('#sidebar .sidebar-scrollbox');
            sidebarScrollbox.addEventListener('click', function(e) {
                if (e.target.tagName === 'A') {
                    sessionStorage.setItem('sidebar-scroll', sidebarScrollbox.scrollTop);
                }
            }, { passive: true });
            var sidebarScrollTop = sessionStorage.getItem('sidebar-scroll');
            sessionStorage.removeItem('sidebar-scroll');
            if (sidebarScrollTop) {
                // preserve sidebar scroll position when navigating via links within sidebar
                sidebarScrollbox.scrollTop = sidebarScrollTop;
            } else {
                // scroll sidebar to current active section when navigating via "next/previous chapter" buttons
                var activeSection = document.querySelector('#sidebar .active');
                if (activeSection) {
                    activeSection.scrollIntoView({ block: 'center' });
                }
            }
        </script>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">Machine Shell Book</h1>

                    <div class="right-buttons">
                        <a href="../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="sql-server-database-using-terraform--docker-locally-ubuntu-2204"><a class="header" href="#sql-server-database-using-terraform--docker-locally-ubuntu-2204">SQL Server database using Terraform &amp; Docker locally Ubuntu 22.04</a></h1>
<p><strong>Auther:</strong> <a href="https://github.com/jldroid19">jldroid19</a></p>
<p><img src="./images/mssql-docker.png" alt="Alt text" /></p>
<p>This post we will be building a Docker container running SQL Server using Terraform as our provisioner.</p>
<p><strong>Source code:</strong> <a href="https://github.com/jldroid19/mssql-td">https://github.com/jldroid19/mssql-td</a></p>
<h3 id="required-os-and-software"><a class="header" href="#required-os-and-software">Required OS and Software</a></h3>
<ol>
<li><strong>Ubuntu 22.04</strong> (This may work on Ubuntu 20.04 as well, no gurantees)</li>
<li><strong>Docker engine:</strong> <a href="https://docs.docker.com/engine/install/ubuntu/">https://docs.docker.com/engine/install/ubuntu/</a></li>
<li><strong>Terraform:</strong> <a href="https://developer.hashicorp.com/terraform/tutorials/aws-get-started/install-cli">https://developer.hashicorp.com/terraform/tutorials/aws-get-started/install-cli</a></li>
<li>(Optional) <strong>Azure Data Studio:</strong> <a href="https://learn.microsoft.com/en-us/sql/azure-data-studio/download-azure-data-studio?view=sql-server-ver16">https://learn.microsoft.com/en-us/sql/azure-data-studio/download-azure-data-studio?view=sql-server-ver16</a></li>
</ol>
<h3 id="needed-files"><a class="header" href="#needed-files">Needed files</a></h3>
<p>A copy of the <strong>AdventureWorksLT2019.bak</strong> which can be retrieved from here: <a href="https://learn.microsoft.com/en-us/sql/samples/adventureworks-install-configure?view=sql-server-ver16&amp;tabs=ssms">https://learn.microsoft.com/en-us/sql/samples/adventureworks-install-configure?view=sql-server-ver16&amp;tabs=ssms</a></p>
<p>Okay let's go ahead and start mapping out our file structure.</p>
<hr />
<p>Open a terminal and create the folder and files needed.</p>
<p><img src="./images/image-2.png" alt="Alt text" /></p>
<ul>
<li><strong>main.tf</strong> (define the provider and resources)</li>
<li><strong>variables.tf</strong> (set variables that will be used to describe the container)</li>
<li><strong>outputs.tf</strong> (tailor some container information to print to the terminal.</li>
<li><strong>database.sh</strong> (bash script used to provision the container with the AdventureWorks database)</li>
</ul>
<ol start="2">
<li>Now go ahead and open up the mssql-td directory with your preferred code editor. You should have something similar to the image below.</li>
</ol>
<p><img src="./images/terraform.png" alt="Alt text" /></p>
<ol start="3">
<li>Let's go ahead and start with our <strong>main.tf</strong> configuration.</li>
</ol>
<p><strong>mssql-td/main.tf</strong></p>
<pre><code>terraform {
  required_providers {
    docker = {
      source  = &quot;kreuzwerker/docker&quot;
      version = &quot;~&gt; 2.13.0&quot;
    }
  }
}

provider &quot;docker&quot; {}

resource &quot;docker_image&quot; &quot;mssql&quot; {
  name         = &quot;mcr.microsoft.com/mssql/server:2019-latest&quot;
  keep_locally = true
}

resource &quot;docker_container&quot; &quot;mssql&quot; {
  image = docker_image.mssql.name
  name  = var.container_name
  env = [&quot;ACCEPT_EULA=Y&quot;, &quot;MSSQL_SA_PASSWORD=Password1!&quot;]

  provisioner &quot;local-exec&quot; {
    command = &quot;sh ./database.sh&quot;
  }
}
</code></pre>
<ol start="4">
<li>Quick overview of the <strong>main.tf</strong> file</li>
</ol>
<ul>
<li><strong>required_providers</strong> - (this is the porvider we will be using to allow Terraform to communicate with docker engines api.)</li>
<li><strong>provider</strong> - (telling Terraform that we will be using docker to build this database.)</li>
<li><strong>resource &quot;docker_image&quot;</strong> - (Defining which image we will be pulling down from docker hub, and telling terraform to keep the image locally even after a terraform destroy.)</li>
<li><strong>resource &quot;docker_container&quot;</strong> - (telling Terraform to use the above image resource for our container, the name of the container which we'll declare as a variable in out variables.tf file. The env value is very important because it accepts the EULA and sets our database password right away. Keepign the password in plain text like this is not recommended for production use.). Now the last bit is the provisioner. Thi is the most important peice of what we're doing. This will call on the database.sh script which has commands that will be executed inside out container during the terraform apply.</li>
</ul>
<ol start="5">
<li>Now let's set our containers 'name' variable. Below is what we want our variables.tf to look like.</li>
</ol>
<p><strong>mssql-td/variables.tf</strong></p>
<pre><code>variable &quot;container_name&quot; {
  description = &quot;MSSQL database, Docker container&quot;
  type        = string
  default     = &quot;mssql&quot;
}
</code></pre>
<ol start="6">
<li>Let's talk about what we have written above.</li>
</ol>
<ul>
<li>
<p>We declared a variable called <strong>&quot;container_name&quot;</strong> which looks familiar to what is in our <strong>main.tf</strong>.</p>
</li>
<li>
<p>In our <strong>&quot;container_name&quot;</strong> variable block we defined what that variable consists of.</p>
</li>
<li>
<p><strong>description</strong> - A short description of what this container is or what           purpose it serves.</p>
</li>
<li>
<p><strong>type</strong> - string (We want this variable to be of string type)</p>
</li>
<li>
<p><strong>default</strong> - The name of our container</p>
</li>
</ul>
<ol start="7">
<li>Now let's configure our <strong>outputs.tf</strong> file. This will give us a place to tailor any output we want about the container to the terminal after we terraform apply. Go ahead and place the below blocks in your outputs.tf file.</li>
</ol>
<p><strong>mssql-td/outputs.tf</strong></p>
<pre><code>output &quot;container_id&quot; {
  description = &quot;ID of the Docker container&quot;
  value       = docker_container.mssql.id
}

output &quot;image_id&quot; {
  description = &quot;ID of the Docker image&quot;
  value       = docker_image.mssql.id
}
</code></pre>
<ol start="8">
<li>Quick overview of the outputs.tf file</li>
</ol>
<ul>
<li><strong>&quot;container_id&quot;</strong> (Gets the container id and prints it to the terminal)</li>
<li><strong>&quot;image_id&quot;</strong> (Gets the image the container is using and prints it to the terminal.)</li>
</ul>
<ol start="9">
<li>Now the final piece to the puzzle is the database.sh script. Place the below in your database.sh file.</li>
</ol>
<p><strong>mssql-td/database.sh</strong></p>
<pre><code>#!/bin/bash

echo &quot;Let's configure this container!&quot;
uname=SA
pwrd=Password1!
bakitup=AdventureWorksLT2019.bak

echo &quot;Creating backup directory&quot;
docker exec -i mssql mkdir /var/opt/mssql/backup

echo &quot;Copying .bak to container&quot;
docker cp AdventureWorksLT2019.bak mssql:/var/opt/mssql/backup

echo &quot;LOADING DATABASE LOGICAL FILES&quot;
docker exec -i mssql /opt/mssql-tools/bin/sqlcmd -S localhost -U $uname -P $pwrd -Q 'RESTORE FILELISTONLY FROM DISK = &quot;/var/opt/mssql/backup/'$bakitup'&quot;' | tr -s ' ' | cut -d ' ' -f 1-2

echo &quot;RESTORING DATABASE&quot;
docker exec -i mssql /opt/mssql-tools/bin/sqlcmd -S localhost -U $uname -P $pwrd -Q 'RESTORE DATABASE AdventureWorksLT2012 FROM DISK = &quot;/var/opt/mssql/backup/'$bakitup'&quot; WITH MOVE &quot;AdventureWorksLT2012_data&quot; TO &quot;/var/opt/mssql/data/AdventureWorksLT2019.mdf&quot;, MOVE &quot;AdventureWorksLT2012_Log&quot; TO &quot;/var/opt/mssql/data/AdventureWorksLT2012_log.ldf&quot;'

echo &quot;DATABASE CONNECTION INFORMATION&quot;
echo &quot;Container IP: &quot;
docker inspect -f '{{range .NetworkSettings.Networks}}{{.IPAddress}}{{end}}' mssql
echo &quot;Username: &quot; $uname
echo &quot;Password: &quot; $pwrd
</code></pre>
<ol start="10">
<li>Quick overview of the <strong>database.sh</strong> script</li>
</ol>
<ul>
<li><strong>mkdir</strong> in the container for the AdventureWorksLT2019.bak file to live</li>
<li><strong>cp</strong> the AdventureWorksLT2019.bak file into the container</li>
<li><strong>exec</strong> the restore of the logical files needed for the full database restore to occur.</li>
<li><strong>exec</strong> the restore of the whole database.</li>
</ul>
<p><strong>Note:</strong> if you are using a different database you'll need to change the database name and logical file names.</p>
<ol start="11">
<li>
<p>Okay I think we are in a good spot to build this container using terraform.</p>
</li>
<li>
<p>Open a terminal and let's start building this thing.</p>
</li>
</ol>
<ul>
<li>Let's initialize the Terraform project using: <code>terraform init</code>
<img src="./images/terraform-success.png" alt="Alt text" /></li>
<li>Now let's cleanup our file formats with: terraform fmt
(If no output is present then that means your formatting is good to          go.</li>
<li>Let's validate our configuration with: <code>terraform validate</code>
<img src="./images/terraform-validate.png" alt="Alt text" /></li>
<li>Let's execute plan to see what were lookign at: <code>terraform plan</code></li>
</ul>
<pre><code>Terraform used the selected providers to generate the following execution plan. Resource actions are indicated with the following
symbols:
  + create

Terraform will perform the following actions:

  # docker_container.mssql will be created
  + resource &quot;docker_container&quot; &quot;mssql&quot; {
      + attach           = false
      + bridge           = (known after apply)
      + command          = (known after apply)
      + container_logs   = (known after apply)
      + entrypoint       = (known after apply)
      + env              = [
          + &quot;ACCEPT_EULA=Y&quot;,
          + &quot;MSSQL_SA_PASSWORD=Password1!&quot;,
        ]
      + exit_code        = (known after apply)
      + gateway          = (known after apply)
      + hostname         = (known after apply)
      + id               = (known after apply)
      + image            = &quot;mcr.microsoft.com/mssql/server:2019-latest&quot;
      + init             = (known after apply)
      + ip_address       = (known after apply)
      + ip_prefix_length = (known after apply)
      + ipc_mode         = (known after apply)
      + log_driver       = &quot;json-file&quot;
      + logs             = false
      + must_run         = true
      + name             = &quot;mssql&quot;
      + network_data     = (known after apply)
      + read_only        = false
      + remove_volumes   = true
      + restart          = &quot;no&quot;
      + rm               = false
      + security_opts    = (known after apply)
      + shm_size         = (known after apply)
      + start            = true
      + stdin_open       = false
      + tty              = false

      + healthcheck {
          + interval     = (known after apply)
          + retries      = (known after apply)
          + start_period = (known after apply)
          + test         = (known after apply)
          + timeout      = (known after apply)
        }

      + labels {
          + label = (known after apply)
          + value = (known after apply)
        }
    }

  # docker_image.mssql will be created
  + resource &quot;docker_image&quot; &quot;mssql&quot; {
      + id           = (known after apply)
      + keep_locally = true
      + latest       = (known after apply)
      + name         = &quot;mcr.microsoft.com/mssql/server:2019-latest&quot;
      + output       = (known after apply)
      + repo_digest  = (known after apply)
    }

Plan: 2 to add, 0 to change, 0 to destroy.

Changes to Outputs:
  + container_id = (known after apply)
  + image_id     = (known after apply)
</code></pre>
<ul>
<li>Okay I think everthing checks out. Let's apply it: terraform apply
Enter a value: yes</li>
</ul>
<p><strong>Note:</strong> If you get an error make sure your database.sh script is            executable (chmod +x database.sh)
<img src="./images/azure-data.png" alt="Alt text" /></p>
<ol start="13">
<li>The container has been successfully built and the AdventureWorks database has been restored. </li>
</ol>
<p><strong>Note:</strong> the Container IP and Username/Password. Let's go ahead and launch Azure Data Studio to see if we can connect to this new container.</p>
<ol start="14">
<li>
<p>Click <strong>'New'</strong> then <strong>'new connection'</strong>. Fill in the connection info, then click <strong>'Connect'</strong>.
<img src="./images/azure-data2.png" alt="Alt text" /></p>
</li>
<li>
<p>Select <strong>'Databases'</strong> and you'll see the <strong>AdventureWorksLT2012</strong> database available for use.</p>
</li>
<li>
<p>Clean up when done: terraform destroy</p>
</li>
</ol>
<p><strong>Conclusion</strong></p>
<p>This terraform - docker configuration should not be used for production. This is purely a way to quickly restore past backup databases into a container. Allowing you to interact with actual operational data at a very low cost. I found this especially useful when developing applications geared towards data analysis. Just remember once you execute terraform destroy this database and any changes you have made to it will be gone. Great for quick database structure access without exposing your cloud development/production environments to developers. Also, it's super free!!!!!!!</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../databases.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>


                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../databases.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="../elasticlunr.min.js"></script>
        <script src="../mark.min.js"></script>
        <script src="../searcher.js"></script>

        <script src="../clipboard.min.js"></script>
        <script src="../highlight.js"></script>
        <script src="../book.js"></script>

        <!-- Custom JS scripts -->


    </div>
    </body>
</html>
